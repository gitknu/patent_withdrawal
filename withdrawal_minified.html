<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Акти списання</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.45.0/docxtemplater.js"></script>
<script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
<script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip-utils.js"></script>
<style>:root{--primary:#007bff;--border-color:#ccc;--background-color:#f8f9fa;--text-color:#212529;--light-text:#6c757d;--success:#28a745;--error:#dc3545;--grey:#adb5bd;--guide-bg:#eef4ff;--guide-text:#0056b3;--error-bg:#f8d7da;--error-text:#721c24}*{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}body{background-color:var(--background-color);color:var(--text-color);line-height:1.5;padding:15px}.container{max-width:1200px;margin:0 auto}header{padding-bottom:20px;margin-bottom:20px;border-bottom:1px solid var(--border-color);position:relative}.header-main{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.header-status{display:flex;align-items:center;gap:20px}.status-counter{text-align:left}.status-value{font-weight:700;font-size:1.5rem;color:var(--primary)}.status-label{font-size:.9rem;color:var(--light-text)}h1{font-size:2rem;text-align:center;margin-bottom:8px}.guide-container{text-align:center;padding-top:5px;min-height:24px}.guide-text{display:inline-block;background-color:var(--guide-bg);color:var(--guide-text);padding:8px 15px;border-radius:20px;font-size:.95rem;font-weight:500;opacity:0;transform:translateY(-10px);transition:opacity .4s ease-out,transform .4s ease-out,background-color .3s,color .3s;max-width:90%}.guide-text.visible{opacity:1;transform:translateY(0)}.final-hint{color:var(--light-text);font-weight:500}.guide-text.error{background-color:var(--error-bg);color:var(--error-text)}.card{background:white;border-radius:5px;border:1px solid var(--border-color);padding:20px;margin-bottom:20px}table{width:100%;border-collapse:collapse;margin-bottom:20px}th,td{padding:8px 10px;border:1px solid var(--border-color);text-align:left;vertical-align:middle}th{background:#f1f1f1;font-weight:600}.status-light-th{width:30px;text-align:center}.status-light{width:12px;height:12px;border-radius:50%;display:inline-block;transition:background-color .3s}.status-grey{background-color:var(--grey)}.status-red{background-color:var(--error)}.status-green{background-color:var(--success)}.editable-cell{padding:6px;min-height:30px;outline:none;border:1px solid transparent}.editable-cell[data-placeholder]:empty:not(:focus):before{content:attr(data-placeholder);color:var(--light-text);opacity:.7;pointer-events:none}.editable-cell:focus{border-color:var(--primary);background:#eef4ff}.editable-cell.invalid{border-color:var(--error);box-shadow:0 0 4px rgba(220,53,69,.4);border-radius:3px}.btn{background-color:var(--primary);color:white;border:1px solid var(--primary);padding:10px 20px;border-radius:5px;font-weight:600;cursor:pointer;font-size:1rem;display:inline-flex;align-items:center;gap:8px}.btn:hover{background-color:#0056b3}.notification{position:fixed;top:20px;right:20px;padding:15px;border-radius:5px;color:white;z-index:1000;opacity:0;transition:opacity .3s;display:none}.notification.show{opacity:1;display:block}.notification.success{background-color:var(--success)}.notification.error{background-color:var(--error)}.loader{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .3s}.loader.active{opacity:1;pointer-events:all}.spinner{width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:15px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.top-generate-btn .btn{padding:8px 15px;font-size:.9rem}@media (max-width:768px){.header-main{flex-direction:column;gap:15px}.header-status{width:100%;justify-content:space-around}.top-generate-btn{width:100%}.top-generate-btn .btn{width:100%;justify-content:center}h1{font-size:1.8rem}.card{overflow-x:auto}}</style>
</head>
<body>
<div class="container">
<header>
<div class="header-main">
<div class="header-status">
<div class="status-counter">
<div class="status-value" id="filled-rows">0/3</div>
<div class="status-label">Заповнено рядків</div>
</div>
<div class="status-counter">
<div class="status-value" id="to-generate">0</div>
<div class="status-label">Буде згенеровано</div>
</div>
</div>
<div class="top-generate-btn">
<button id="generate-btn-top" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>Згенерувати</button>
</div>
</div>
<h1>Генератор актів списання</h1>
<div class="guide-container"><span id="guide-text-element" class="guide-text"></span></div>
</header>
<div class="card">
<h2 class="card-title">Таблиця даних</h2>
<table>
<thead>
<tr>
<th>#</th>
<th class="status-light-th"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg></th>
<th>Номер</th><th>Тип</th><th>Назва</th><th>Номер НД</th><th>Початок</th><th>Кінець</th><th>Вартість</th><th>Підписує</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>
<div class="btn-container">
<button id="generate-btn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>Згенерувати DOCX файли</button>
</div>
</div>
<div class="notification" id="notification"></div>
<div class="loader" id="loader">
<div class="spinner"></div>
<div class="loader-text">Генеруємо документи...</div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded',()=>{const d=document,T='https://gitknu.github.io/patent_withdrawal/input_patent_withdrawal.docx',P=['num_p','type','name','num_db','start','end','value','person'],I=3,M=50,C=[{s:'td:nth-child(3) .editable-cell.invalid',m:'Помилка: "Номер" має містити від 5 до 7 <b>унікальних</b> цифр.'},{s:'td:nth-child(4) .editable-cell.invalid',m:'Помилка: "Тип" невірний. Введіть "в", "к" або "т".'},{s:'td:nth-child(6) .editable-cell.invalid',m:'Помилка: "Номер НД" має містити рівно <b>9</b> цифр.'},{s:'td:nth-child(7) .editable-cell.invalid, td:nth-child(8) .editable-cell.invalid',m:'Помилка: Перевірте <b>дати</b>. Невірний формат або логіка.'},{s:'td:nth-child(9) .editable-cell.invalid',m:'Помилка: "Вартість" має формат <b>1234,56</b>.'},{s:'td:nth-child(10) .editable-cell.invalid',m:'Помилка: "Підписує" має формат <b>Ім\'я ПРІЗВИЩЕ</b>.'}],S=[{t:"Введіть у першому полі від 5 до 7 цифр номеру патенту"},{t:"Чудово! Натисніть Tab для переходу далі"},{t:"Тепер введіть 'в', 'к' або 'т' для вибору типу"},{t:"Добре. Для навігації використовуйте Tab та Shift + Tab"},{t:"Заповніть решту полів у цьому рядку"},{t:"Майже готово! Заповніть останнє поле у форматі 'Ім\'я ПРІЗВИЩЕ'"},{t:"Рядок заповнено! Натисніть Esc, щоб вийти з редагування"},{t:"Супер! Тепер тисніть Enter, щоб згенерувати документи"},{t:"<span class='final-hint'>Shift+Tab: Назад | Tab: Вперед | Esc: Вийти | Enter: Згенерувати</span>"}],tb=d.getElementById('table-body'),gb=d.getElementById('generate-btn'),gbt=d.getElementById('generate-btn-top'),n=d.getElementById('notification'),fr=d.getElementById('filled-rows'),tg=d.getElementById('to-generate'),l=d.getElementById('loader'),gt=d.getElementById('guide-text-element');let ta=true,ts=0;function Ga(m){if(ta)return;gt.classList.remove('visible');setTimeout(()=>{gt.innerHTML=m;gt.classList.add('error','visible')},150)}function Gt(i){if(!ta&&i<S.length-1||ta&&i<ts)return;ts=i;const s=S[i];gt.classList.remove('visible');setTimeout(()=>{gt.innerHTML=s.t;gt.classList.remove('error');gt.classList.add('visible')},200)}function Et(){if(!ta)return;ta=false;setTimeout(()=>Gt(S.length-1),500)}function vDate(s){if(!/^\d{2}\.\d{2}\.\d{4}$/.test(s))return!1;const[day,month,year]=s.split('.').map(p=>parseInt(p,10));if(year<1939||year>2100||month<1||month>12)return!1;const dt=new Date(year,month-1,day);return dt.getFullYear()===year&&dt.getMonth()===month-1&&dt.getDate()===day}function pDate(s){const p=s.split('.');return new Date(p[2],p[1]-1,p[0])}function vNum(){const cs=tb.querySelectorAll('td:nth-child(3) .editable-cell'),vs={};cs.forEach(c=>{const v=c.textContent.trim();if(v){if(!vs[v])vs[v]={c:0,cs:[]};vs[v].c++;vs[v].cs.push(c)}});cs.forEach(c=>{const t=c.textContent.trim(),lenInvalid=t!==''&&!/^\d{5,7}$/.test(t),isDup=t!==''&&vs[t]&&vs[t].c>1;c.classList.toggle('invalid',lenInvalid||isDup)});const fc=tb.querySelector('tr:first-child td:nth-child(3) .editable-cell');if(fc&&!fc.classList.contains('invalid')&&fc.textContent.length>=5&&fc.textContent.length<=7)Gt(1)}function vDateRow(r){const sc=r.querySelector('td:nth-child(7) .editable-cell'),ec=r.querySelector('td:nth-child(8) .editable-cell'),tc=r.querySelector('td:nth-child(4) .editable-cell');if(!sc||!ec||!tc)return;const ss=sc.textContent.trim(),es=ec.textContent.trim();sc.classList.remove('invalid');ec.classList.remove('invalid');const sFmt=ss===''||vDate(ss),eFmt=es===''||vDate(es);if(ss!==''&&!sFmt)sc.classList.add('invalid');if(es!==''&&!eFmt)ec.classList.add('invalid');if(sFmt&&eFmt&&ss!==''&&es!==''){const sd=pDate(ss),ed=pDate(es);if(ed<=sd){sc.classList.add('invalid');ec.classList.add('invalid');return}const ts=tc.textContent.trim();let my=0;if(ts==='корисну модель'||ts==='торговельну марку')my=20;else if(ts==='винахід')my=30;if(my>0){const med=new Date(sd.getTime());med.setFullYear(med.getFullYear()+my);if(ed>med){sc.classList.add('invalid');ec.classList.add('invalid')}}}}function addRow(){const i=tb.rows.length,r=d.createElement('tr');let h=`<td>${i+1}</td><td><div class="status-light status-grey"></div></td>`;P.forEach(()=>h+=`<td><div class="editable-cell" contenteditable="true"></div></td>`);r.innerHTML=h;tb.appendChild(r)}function updSt(){const rs=tb.querySelectorAll('tr');let crc=0;rs.forEach((r,ri)=>{const cs=r.querySelectorAll('.editable-cell'),sl=r.querySelector('.status-light');let fcc=0,inv=!!r.querySelector('.editable-cell.invalid');cs.forEach(c=>{if(c.textContent.trim()!=='')fcc++});const isC=fcc===cs.length&&!inv;if(fcc===0)sl.className='status-light status-grey';else if(!isC)sl.className='status-light status-red';else{sl.className='status-light status-green';crc++}if(ta&&ri===0&&isC&&d.activeElement===r.querySelector('td:last-child .editable-cell'))Gt(6)});fr.textContent=`${crc}/${rs.length}`;tg.textContent=crc}function showNotif(m,suc=true){n.textContent=m;n.className=`notification ${suc?'success':'error'} show`;setTimeout(()=>n.classList.remove('show'),5e3)}async function genDocs(){if(ta)Et();for(const c of C){const ic=tb.querySelectorAll(c.s);if(ic.length>0){Ga(c.m);ic[0].focus();return}}const data=(()=>{const dt=[];tb.querySelectorAll('tr').forEach(r=>{const cs=r.querySelectorAll('.editable-cell');let allF=true,hasD=false;const rd={};cs.forEach((c,i)=>{const v=c.textContent.trim();rd[P[i]]=v;if(v!=='')hasD=true;else allF=false});if(hasD&&allF&&!r.querySelector('.editable-cell.invalid'))dt.push(rd)});return dt})();if(data.length===0){Ga('Помилка: Немає повністю та коректно заповнених рядків для генерації.');return}try{l.classList.add('active');const templ=await new Promise((res,rej)=>{PizZipUtils.getBinaryContent(T,(err,cont)=>{if(err)rej(new Error('Помилка завантаження шаблону.'));else res(cont)})});for(const[i,rd]of data.entries()){const zip=new PizZip(templ),doc=new docxtemplater(zip,{delimiters:{start:'<',end:'>'}});doc.setData(rd);doc.render();const out=doc.getZip().generate({type:'blob',mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});saveAs(out,`${i+1}_Акт_${rd.num_p||'Номер'}.docx`)}showNotif(`Успішно згенеровано ${data.length} документів!`)}catch(e){Ga(`Критична помилка: ${e.message}`)}finally{l.classList.remove('active')}}function chkErr(r){if(!r)return;for(const c of C){if(r.querySelector(c.s)){Ga(c.m);return}}if(gt.classList.contains('error'))Gt(S.length-1)}for(let i=0;i<I;i++)addRow();updSt();const fc=tb.querySelector('tr:first-child .editable-cell');if(fc)fc.focus();Gt(0);gb.addEventListener('click',genDocs);gbt.addEventListener('click',genDocs);d.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.target.classList.contains('editable-cell')){e.preventDefault();genDocs()}else if(e.key==='Escape'||e.key==='Esc'){if(d.activeElement.classList.contains('editable-cell')){d.activeElement.blur();if(ta)Gt(7)}}});tb.addEventListener('focusin',e=>{const c=e.target;if(!c.classList.contains('editable-cell'))return;const pr=c.closest('tr');if(ta&&pr!==tb.firstElementChild)Et();if(!ta)return;const ci=c.closest('td').cellIndex;if(ci===3)Gt(2);if(ci===4)Gt(4);if(ci===9)Gt(5)});tb.addEventListener('keydown',e=>{const c=e.target;if(!c.classList.contains('editable-cell'))return;const iChar=e.key.length===1&&!e.ctrlKey&&!e.metaKey,ci=c.closest('td').cellIndex;if(e.key==='Tab'&&c.classList.contains('invalid')){e.preventDefault();return}const mLs={2:7,5:9,6:10,7:10,8:12};if(mLs[ci]&&c.textContent.length>=mLs[ci]&&iChar&&window.getSelection().toString().length===0)e.preventDefault();if((ci===2||ci===5)&&!/^\d$/.test(e.key)&&iChar)e.preventDefault();else if((ci===6||ci===7)&&!/^[\d.]$/.test(e.key)&&iChar)e.preventDefault();else if(ci===8&&!/^[\d,]*$/.test(e.key)&&iChar)e.preventDefault();else if(ci===9&&!/^[А-ЯІЇЄҐа-яіїєґ' -]$/u.test(e.key)&&iChar)e.preventDefault();if(ci===3){const vT=['винахід','корисну модель','торговельну марку'];if(e.key==='Backspace'||e.key==='Delete'){e.preventDefault();c.textContent='';c.classList.remove('invalid');vDateRow(c.closest('tr'));updSt()}else if(vT.includes(c.textContent.trim())&&iChar)e.preventDefault()}});tb.addEventListener('input',e=>{const c=e.target;if(!c.classList.contains('editable-cell'))return;const pT=c.closest('td'),pR=c.closest('tr');if(!pT||!pR)return;const ci=pT.cellIndex;if(ci===2)vNum();if(ci===3){const t=c.textContent.trim().toLowerCase(),tM={'в':'винахід','к':'корисну модель','т':'торговельну марку'};if(t.length===1&&tM[t]){c.textContent=tM[t];const r=d.createRange(),s=window.getSelection();r.selectNodeContents(c);r.collapse(false);s.removeAllRanges();s.addRange(r)}const vT=Object.values(tM),isV=c.textContent===''||vT.includes(c.textContent);c.classList.toggle('invalid',!isV);if(ta&&pR===tb.firstElementChild&&isV&&c.textContent!=='')Gt(3)}if(ci===5)c.classList.toggle('invalid',c.textContent!==''&&!/^\d{9}$/.test(c.textContent));if(ci===6||ci===7)vDateRow(pR);if(ci===8)c.classList.toggle('invalid',c.textContent!==''&&!/^\d{1,9},\d{2}$/.test(c.textContent));if(ci===9){const txt=c.textContent.trim();c.classList.toggle('invalid',txt!==''&&!/^[А-ЯІЇЄҐ][а-яіїєґ']+ [А-ЯІЇЄҐ'-]+$/u.test(txt))}if(ci===8||ci===6||ci===7){const sep=ci===8?',':'.',wSep=sep===','?'.':',';if(c.textContent.includes(wSep)){const sel=window.getSelection(),off=sel.getRangeAt(0).startOffset;c.textContent=c.textContent.replace(new RegExp(`\\${wSep}`,'g'),sep);if(c.firstChild){const nO=Math.min(off,c.firstChild.length),nR=d.createRange();nR.setStart(c.firstChild,nO);nR.collapse(true);sel.removeAllRanges();sel.addRange(nR)}}}chkErr(pR);if(pR===tb.lastElementChild&&tb.rows.length<M)addRow();updSt()});const fcs=tb.querySelectorAll('tr:first-child .editable-cell'),phs=['123456','в/к/т','МАШИНА ЧАСУ','123456789','01.01.2000','31.12.2020','1000,00','Тарас ШЕВЧЕНКО'];fcs.forEach((c,i)=>{if(phs[i])c.setAttribute('data-placeholder',phs[i])})});
</script>
</body>
</html>
