<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор документів</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Required JavaScript libraries for DOCX generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.1/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip-utils.js"></script>

    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Style for editable cells */
        [contenteditable]:focus {
            outline: 2px solid #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* Basic table styling */
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        
        th {
            background-color: #f9fafb; /* gray-50 */
            font-weight: 600;
            color: #374151; /* gray-700 */
        }

        tbody tr:hover {
            background-color: #f9fafb; /* gray-50 */
        }

        /* Simple fade-in animation for modals */
        .modal-fade-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-fade-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <!-- Main container -->
    <div class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <!-- Header Section -->
        <header class="flex items-center justify-between mb-6 border-b pb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Генератор документів</h1>
            <button id="generate-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-sm flex items-center">
                <svg id="generate-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.293 6.707z" clip-rule="evenodd" />
                </svg>
                <svg id="loader-icon" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="btn-text">Згенерувати</span>
            </button>
        </header>
        
        <!-- Instructional Text -->
        <p class="text-gray-600 mb-6">
            Заповніть таблицю нижче. Кожен заповнений рядок буде використано для створення окремого DOCX-файлу на основі шаблону. Порожні рядки будуть проігноровані.
        </p>

        <!-- Data Table -->
        <div class="overflow-x-auto rounded-lg border">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-4 py-3">Номер</th>
                        <th class="px-4 py-3">Тип</th>
                        <th class="px-4 py-3">Назва</th>
                        <th class="px-4 py-3">Номер НД</th>
                        <th class="px-4 py-3">Початок</th>
                        <th class="px-4 py-3">Кінець</th>
                        <th class="px-4 py-3">Вартість</th>
                        <th class="px-4 py-3">Підписує</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <!-- Rows are now created dynamically by the main script -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-fade-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex items-start">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Помилка валідації</h3>
                    <div class="mt-2">
                        <p id="modal-message" class="text-sm text-gray-500">Some message here.</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button id="close-modal-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Зрозуміло
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const generateBtn = document.getElementById('generate-btn');
        const tableBody = document.getElementById('data-table-body');
        const loaderIcon = document.getElementById('loader-icon');
        const generateIcon = document.getElementById('generate-icon');
        const btnText = document.getElementById('btn-text');
        const errorModal = document.getElementById('error-modal');
        const modalMessage = document.getElementById('modal-message');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- Initialize Table ---
        // Creates the initial 10 empty rows for the user to fill in.
        const initializeTable = () => {
            for (let i = 0; i < 10; i++) {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                for (let j = 0; j < 8; j++) {
                    const cell = document.createElement('td');
                    cell.setAttribute('contenteditable', 'true');
                    cell.className = 'px-4 py-2';
                    row.appendChild(cell);
                }
                tableBody.appendChild(row);
            }
        };
        initializeTable(); // Call the function to build the table on page load
        
        // --- Constants ---
        const DOCX_TEMPLATE_URL = 'https://cors-anywhere.herokuapp.com/https://gitknu.github.io/patent_withdrawal/input_patent_withdrawal.docx';
        // A CORS proxy is used to prevent cross-origin errors when fetching the template in a browser.
        // For production, it's better to host the template on the same domain or configure CORS on the server.
        
        const TEMPLATE_KEYS = ['num_p', 'type', 'name', 'num_db', 'start', 'end', 'value', 'person'];

        // --- Utility Functions ---

        /**
         * Fetches a file from a URL as binary content.
         * @param {string} url The URL of the file to fetch.
         * @param {function} callback The function to call with the result (error, content).
         */
        const loadFile = (url, callback) => {
            PizZipUtils.getBinaryContent(url, (error, content) => {
                if (error) {
                    // Handle network errors or CORS issues
                    let friendlyError = 'Не вдалося завантажити шаблон DOCX. ';
                    if (error.message.includes('HTTP Status')) {
                        friendlyError += `Сталася помилка мережі (статус: ${error.message.split(' ').pop()}). Перевірте своє інтернет-з'єднання та доступ до URL шаблону. Можливо, потрібен CORS-проксі.`;
                    } else {
                        friendlyError += `Перевірте консоль браузера для отримання детальної інформації про помилку.`;
                    }
                    console.error("loadFile error:", error);
                    return callback(new Error(friendlyError), null);
                }
                return callback(null, content);
            });
        };

        /**
         * Shows or hides the loading state on the generate button.
         * @param {boolean} isLoading - True to show loader, false to hide.
         */
        const setLoadingState = (isLoading) => {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.classList.add('cursor-not-allowed', 'opacity-75');
                loaderIcon.classList.remove('hidden');
                generateIcon.classList.add('hidden');
                btnText.textContent = 'Генерація...';
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('cursor-not-allowed', 'opacity-75');
                loaderIcon.classList.add('hidden');
                generateIcon.classList.remove('hidden');
                btnText.textContent = 'Згенерувати';
            }
        };
        
        /**
         * Shows the error modal with a specific message.
         * @param {string} message - The error message to display.
         */
        const showErrorModal = (message) => {
            modalMessage.textContent = message;
            errorModal.classList.remove('hidden');
            // Add animation class
            requestAnimationFrame(() => {
                errorModal.classList.add('modal-fade-enter-active');
            });
        };

        /**
         * Hides the error modal.
         */
        const hideErrorModal = () => {
            errorModal.classList.remove('modal-fade-enter-active');
            errorModal.classList.add('hidden');
        };

        /**
         * Main function to generate documents.
         */
        const generateDocuments = () => {
            setLoadingState(true);

            // 1. Collect and validate data from the table
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const dataToProcess = [];

            for (let i = 0; i < rows.length; i++) {
                const cells = Array.from(rows[i].querySelectorAll('td'));
                const rowData = cells.map(cell => cell.textContent.trim());

                const isRowEmpty = rowData.every(cellText => cellText === '');
                if (isRowEmpty) {
                    continue; // Skip empty rows
                }

                const isRowIncomplete = rowData.some(cellText => cellText === '');
                if (isRowIncomplete) {
                    showErrorModal(`Помилка в рядку ${i + 1}: всі стовпці повинні бути заповнені, якщо рядок не порожній.`);
                    setLoadingState(false);
                    return; // Stop processing
                }

                const docData = {};
                TEMPLATE_KEYS.forEach((key, index) => {
                    docData[key] = rowData[index];
                });
                dataToProcess.push(docData);
            }

            if (dataToProcess.length === 0) {
                showErrorModal('Не знайдено даних для генерації. Будь ласка, заповніть хоча б один рядок у таблиці.');
                setLoadingState(false);
                return;
            }

            // 2. Load the template and generate files
            loadFile(DOCX_TEMPLATE_URL, (error, content) => {
                if (error) {
                    showErrorModal(error.message);
                    setLoadingState(false);
                    return;
                }

                try {
                    // 3. Loop through each valid data row and generate a document
                    dataToProcess.forEach((data, index) => {
                        const zip = new PizZip(content);
                        const doc = new docxtemplater(zip, {
                            paragraphLoop: true,
                            linebreaks: true,
                        });
                        
                        // Set the template data
                        doc.setData(data);
                        
                        // Render the document
                        doc.render();

                        // Generate the output as a blob
                        const out = doc.getZip().generate({
                            type: "blob",
                            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                        });
                        
                        // Use FileSaver to trigger download
                        // Use the value of 'num_p' for a unique filename
                        const fileName = `document_${data.num_p || index + 1}.docx`;
                        saveAs(out, fileName);
                    });
                } catch (renderError) {
                    console.error("Docxtemplater render error:", renderError);
                    showErrorModal(`Помилка під час створення DOCX: ${renderError.message}. Перевірте, чи відповідають теги в шаблоні (${TEMPLATE_KEYS.join(', ')}) очікуваним.`);
                } finally {
                    // 4. Reset loading state after completion or error
                    setLoadingState(false);
                }
            });
        };

        // --- Event Listeners ---
        generateBtn.addEventListener('click', generateDocuments);
        closeModalBtn.addEventListener('click', hideErrorModal);
    </script>
</body>
</html>
